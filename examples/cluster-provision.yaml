name: Cluster provisioner

# The name for workflow runs generated from the workflow.
run-name: Cluster ${{ github.event.inputs.cluster_provisioner_command }}

on:
  workflow_dispatch:
    inputs:
      cluster_provisioner_command:
        description: 'Enter command action for cluster provisioner, available: provision or destroy.'
        required: true
        default: 'provision'
        type: choice
        options:
          - provision
          - destroy
      rmk_version:
        description: 'Specific RMK version.'
        required: false
        default: latest

env:
  # The cluster provider: "azure", "aws", "gcp"
  CLUSTER_PROVIDER: "aws"

jobs:
  cluster-provision:
    name: 'Cluster will be ${{ github.event.inputs.cluster_provisioner_command }} for branch: ${{ github.ref_name }}.'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Run gitlabflow action
        uses: edenlab/gitlabflow.cd.action@v2
        with:
          cluster_provider_credentials: ${{ secrets.CLUSTER_PROVIDER_CREDENTIALS }}
          github_token_repo_full_access: ${{ secrets.GH_TOKEN_REPO_FULL_ACCESS }}
          rmk_cluster_provider: ${{ env.CLUSTER_PROVIDER }}
          rmk_command: ${{ inputs.cluster_provisioner_command }}
          rmk_version: ${{ inputs.rmk_version }}
